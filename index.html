<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Meteorológico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #f5f5f5;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 400px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }

    .sensor-card,
    .chart-card {
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
      padding: 20px;
      background: white;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 120px;
    }

    .chart-card {
      min-height: 250px;
    }

    canvas {
      width: 100% !important;
      height: auto !important;
    }

    @media (max-width: 768px) {
      #map {
        height: 300px;
      }

      .sensor-card h5 {
        font-size: 1rem;
      }

      .sensor-card p {
        font-size: 0.9rem;
      }

      .chart-card {
        min-height: 200px;
        padding: 10px;
      }
    }

    @media (max-width: 576px) {

      .sensor-card,
      .chart-card {
        min-height: auto;
        padding: 15px;
      }
    }
  </style>
</head>

<body>

  <div class="container py-4">
    <h1 class="text-center mb-2">Dashboard Meteorológico</h1>
    <p class="text-center text-muted mb-4" id="dia-actual">--</p>

    <!-- Mapa -->
    <div id="map"></div>

    <!-- Tarjetas de sensores -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-sm-6 col-md-3">
        <div class="sensor-card">
          <h5>Temperatura</h5>
          <p id="temp">-- °C</p>
          <small class="text-muted" id="fecha-temp">--</small>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-3">
        <div class="sensor-card">
          <h5>Humedad</h5>
          <p id="hum">-- %</p>
          <small class="text-muted" id="fecha-hum">--</small>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-3">
        <div class="sensor-card">
          <h5>Calidad Aire</h5>
          <p id="air">--</p>
          <small class="text-muted" id="fecha-air">--</small>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-3">
        <div class="sensor-card">
          <h5>Luminancia</h5>
          <p id="lum">--</p>
          <small class="text-muted" id="fecha-lum">--</small>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-3">
        <div class="sensor-card">
          <h5>Presión</h5>
          <p id="pres">-- hPa</p>
          <small class="text-muted" id="fecha-pres">--</small>
        </div>
      </div>
       <div class="col-12 col-sm-6 col-md-3">
        <div class="sensor-card">
          <h5>Lluvia</h5>
          <p id="lluvia"></p>
          <small class="text-muted" id="fecha-pres">--</small>
        </div>
      </div>
    </div>

    <!-- Gráficas -->
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <div class="chart-card h-100">
          <canvas id="tempChart"></canvas>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="chart-card h-100">
          <canvas id="humChart"></canvas>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="chart-card h-100">
          <canvas id="airChart"></canvas>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="chart-card h-100">
          <canvas id="lumChart"></canvas>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="chart-card h-100">
          <canvas id="presChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const CHANNEL_ID = "3131415";
    const API_KEY = "7TVP2MAWPX5C1IYL";
    const RESULTS = 20;
    const URL = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${API_KEY}&results=${RESULTS}`;

    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    /*
    const ubicacionFija = [14.515865, -90.583091]; // Villa Nueva, Guatemala
    L.marker(ubicacionFija).addTo(map)
      .bindPopup("Estación Meteorológica - Villa Nueva").openPopup();
    map.setView(ubicacionFija, 15);
    */
    let marker, polyline;
    let tempChart, humChart, airChart, lumChart, presChart,lluviaChart;

    function mostrarDiaActual() {
      const hoy = new Date();
      const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const diaTexto = hoy.toLocaleDateString('es-ES', opciones);
      document.getElementById("dia-actual").innerText = diaTexto.charAt(0).toUpperCase() + diaTexto.slice(1);
    }

    function interpretarLuz(valor) {
      if (isNaN(valor)) return "Sin datos";
      if (valor < 100) return "Ambiente oscuro";
      if (valor < 300) return "Nublado o sombra";
      if (valor < 700) return "Día parcialmente soleado";
      return "Día soleado";
    }

    function interpretarLluvia(valor) {
      if (isNaN(valor)) return "Sin datos";
      if (valor == 0) return "Está Lloviendo";
      return "Sin Lluvia";
    }


    async function actualizarDatos() {
      try {
        const res = await fetch(URL);
        const data = await res.json();
        const feeds = data.feeds;

        const latlngs = feeds.slice(-10).map(f => [parseFloat(f.field5), parseFloat(f.field6)]).filter(v => !isNaN(v[0]) && !isNaN(v[1]));
        if (marker) map.removeLayer(marker);
        if (polyline) map.removeLayer(polyline);
        if (latlngs.length > 0) {
          marker = L.marker(latlngs[latlngs.length - 1]).addTo(map)
            .bindPopup(`Lat: ${latlngs[latlngs.length - 1][0]}<br>Lon: ${latlngs[latlngs.length - 1][1]}`).openPopup();
          map.setView(latlngs[latlngs.length - 1], 15);
          polyline = L.polyline(latlngs, { color: 'red' }).addTo(map);
        }

        const ultimo = feeds[feeds.length - 1];
        const temp = parseFloat(ultimo.field1);
        const hum = parseFloat(ultimo.field2);
        const air = parseFloat(ultimo.field4);
        const lum = parseFloat(ultimo.field7);
        const pres = parseFloat(ultimo.field3);
        const lluvia = parseFloat(ultimo.field8);



        const fecha = new Date(ultimo.created_at);
        const fechaLocal = fecha.toLocaleDateString('es-ES', {
          weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'
        });

        document.getElementById("temp").innerText = !isNaN(temp) ? temp + " °C" : "--";
        document.getElementById("hum").innerText = !isNaN(hum) ? hum + " %" : "--";
        document.getElementById("air").innerText = !isNaN(air) ? air : "--";
        document.getElementById("lum").innerText = !isNaN(lum) ? lum : "--";
        document.getElementById("lum").innerText += !isNaN(lum) ? ` (${interpretarLuz(lum)})` : "";
        document.getElementById("lluvia").innerText += !isNaN(lluvia) ? ` (${interpretarLluvia(lluvia)})` : "";
        document.getElementById("pres").innerText = !isNaN(pres) ? pres + " hPa" : "--";
        document.getElementById("fecha-pres").innerText = fechaLocal;


        document.getElementById("fecha-temp").innerText = fechaLocal;
        document.getElementById("fecha-hum").innerText = fechaLocal;
        document.getElementById("fecha-air").innerText = fechaLocal;
        document.getElementById("fecha-lum").innerText = fechaLocal;

        const labels = feeds.map(f => {
          const fecha = new Date(f.created_at);
          return fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          });
        });


        const tempData = feeds.map(f => parseFloat(f.field1)).map(v => isNaN(v) ? null : v);
        const humData = feeds.map(f => parseFloat(f.field2)).map(v => isNaN(v) ? null : v);
        const airData = feeds.map(f => parseFloat(f.field4)).map(v => isNaN(v) ? null : v);
        const lumData = feeds.map(f => parseFloat(f.field7)).map(v => isNaN(v) ? null : v);
        const presData = feeds.map(f => parseFloat(f.field3)).map(v => isNaN(v) ? null : v);
        const lluviaData = feeds.map(f => parseFloat(f.field8)).map(v => isNaN(v) ? null : v);


        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                title: function (context) {
                  const index = context[0].dataIndex;
                  const fecha = new Date(feeds[index].created_at);
                  return fecha.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                  });
                }
              }
            }
          }
        };
        if (!tempChart) {
          tempChart = new Chart(document.getElementById('tempChart'), { type: 'line', data: { labels, datasets: [{ label: 'Temperatura (°C)', data: tempData, borderColor: 'red', fill: false }] }, options: chartOptions });
          humChart = new Chart(document.getElementById('humChart'), { type: 'line', data: { labels, datasets: [{ label: 'Humedad (%)', data: humData, borderColor: 'blue', fill: false }] }, options: chartOptions });
          airChart = new Chart(document.getElementById('airChart'), { type: 'line', data: { labels, datasets: [{ label: 'Calidad Aire', data: airData, borderColor: 'green', fill: false }] }, options: chartOptions });
          lumChart = new Chart(document.getElementById('lumChart'), { type: 'line', data: { labels, datasets: [{ label: 'Luminancia', data: lumData, borderColor: 'orange', fill: false }] }, options: chartOptions });
          presChart = new Chart(document.getElementById('presChart'), {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Presión (hPa)',
                data: presData,
                borderColor: 'purple',
                fill: false
              }]
            },
            options: chartOptions
          });
        } else {
          tempChart.data.labels = labels; tempChart.data.datasets[0].data = tempData; tempChart.update();
          humChart.data.labels = labels; humChart.data.datasets[0].data = humData; humChart.update();
          airChart.data.labels = labels; airChart.data.datasets[0].data = airData; airChart.update();
          lumChart.data.labels = labels; lumChart.data.datasets[0].data = lumData; lumChart.update();
          presChart.data.labels = labels; presChart.data.datasets[0].data = presData; presChart.update();

        }

      } catch (err) { console.error("Error al obtener datos:", err); }
    }

    actualizarDatos();
    setInterval(actualizarDatos, 30000);
  </script>
</body>


</html>
